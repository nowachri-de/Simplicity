<!DOCTYPE html>
<html lang="en" >

	<head>
	  <meta charset="UTF-8">
	  <title>MatMul GPU</title>
	  <script src="js/glfunctions.js"></script>
	  <script src="js/shader.js"></script>
	  <script src="js/program.js"></script>
	  <script src="js/resultreader.js"></script>
	  <script src="js/util.js"></script>
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.4.2/math.min.js"></script>
	  
	</head>

	<body>
		<canvas id="canvas"></canvas>
		
		<script>
		    //Create two matrices 
			var matrixA  = new Matrix(2,2);
			var matrixB  = new Matrix(2,2);
			var matrixC  = new Matrix(2,2);
			var matrixD  = new Matrix(2,2);
			
			//Do random initialization
			matrixA.randomInitialize();
			matrixB.randomInitialize();
			matrixC.randomInitialize();
			matrixD.randomInitialize();
			
			console.log("Matrix A");
			matrixA.print(5);
			
			console.log("Matrix B");
			matrixB.print(5);
			
			console.log("Matrix C");
			matrixC.print(5);
			
			console.log("Matrix D");
			matrixD.print(5);
			
			var MatrixStorage = new MatrixStorage();
			MatrixStorage.addMatrix(matrixA,'R');
			MatrixStorage.addMatrix(matrixB,'G');
			MatrixStorage.addMatrix(matrixC,'B');
			MatrixStorage.addMatrix(matrixD,'A');
				
			var program			 = new Program("canvas");
			var textureFactory 	 = new TextureFactory("canvas");
			var outputDimensions = MatrixStorage.getResultMatrixDimensions();
			
			console.log(outputDimensions);
			console.log(MatrixStorage.getTexels());
			
			var texture 				= textureFactory.createTextureByDimension("inputTexture",MatrixStorage.maxRows,MatrixStorage.maxColumns,MatrixStorage.getTexels());
			var resultTexture   		= textureFactory.createResultTexture('resultTexture',outputDimensions);
			var readableTexture 		= textureFactory.createReadableTexture('readableTexture',outputDimensions);
			
			var shader =  new Shader(program.gl);
			var vertexShader   = shader.getVertexShader(ShaderCode.getCode("VERTEX"));
			var fragmentShader = shader.getFragmentShader(ShaderCode.getCode("SINGLE"))
			
			program.buildProgram(vertexShader,fragmentShader);
			logTime(matrixA,matrixB,program.multiplySingleTexture(texture,resultTexture,outputDimensions,0,1,0));
		
			//console.log("GPU MatMul ---------------------");
			//gpuPrint(program,resultTexture,readableTexture,0);
			
			var resultReader = new ResultReader(program.gl,"canvas");
			var result = resultReader.read(resultTexture,readableTexture,0);
			
			validateMultiplicationResult(matrixA,matrixB,result);
			
			
			gpuPrint(program,resultTexture,readableTexture,0);
			mathJSPrint(matrixA,matrixB,5);
			
			t0 = performance.now();
			program.multiplySingleTexture(texture,resultTexture,outputDimensions,2,3,0);
			t1 = performance.now();
			console.log("GPU time for matmul " + (t1 - t0) + " milliseconds.")
			
			resultReader = new ResultReader(program.gl,"canvas");
			result = resultReader.read(resultTexture,readableTexture,0);
			console.log("GPU MatMul ---------------------");
			result.print(5);
			
			/*
				Compare the result of the GPU matrix multiplication
				With the result of a matrix multiplication on CPU
			*/
			mat1 = math.matrix(matrixC.as2DArray());
			mat2 = math.matrix(matrixD.as2DArray());
			resultDimensions = matrixC.getResultMatrixDimensions(matrixD);
			
			result2 = math.multiply(mat1,mat2);
			console.log("JS MatMul ---------------------");
			for (var row = 0; row < resultDimensions.height; row++) {
				var tmp = "";
				for (var col = 0; col < resultDimensions.width; col++) {
					 tmp += (result2.subset(math.index(row, col))).toFixed(5) + " ; ";
				}
				console.log(tmp);
			}
			
			textureFactory.free();
			program.free();
			
		</script>
		
	</body>
</html>
